Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:42<00:42, 42.20s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:50<00:00, 21.97s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:50<00:00, 25.01s/it]
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:01<00:01,  1.50s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:01<00:00,  1.33it/s]Loading checkpoint shards: 100%|██████████| 2/2 [00:01<00:00,  1.16it/s]
/home/ctisseau/llm_lcd_finetune/ConstraintLM/constraintlm/processors/guide.py:107: UserWarning: Outlines' public *community-contributed* CFG structured generation is experimental. Please review https://dottxt-ai.github.io/outlines/latest/reference/generation/cfg#disclaimer
  warnings.warn(
Epoch 1/3:   0%|          | 0/8 [00:00<?, ?it/s]Epoch 1/3:   0%|          | 0/8 [00:14<?, ?it/s]Epoch 1/3:   0%|          | 0/8 [03:41<?, ?it/s]
Traceback (most recent call last):
  File "/home/ctisseau/llm_lcd_finetune/finetune.py", line 353, in <module>
    finetune(
  File "/home/ctisseau/llm_lcd_finetune/finetune.py", line 275, in finetune
    biased_logits[i, j, :] = cfg.process_logits(batch_input_ids[i, :j].unsqueeze(0), logits[i, j, :].unsqueeze(0)).squeeze(0)  # returns shape (batch, seq_len, vocab)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ctisseau/llm_lcd_finetune/ConstraintLM/constraintlm/processors/structured.py", line 61, in process_logits
    curr_state = self.guide.get_next_state(prev_state, self.tensor_adapter.to_list(gen_ids[-1]))
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ctisseau/llm_lcd_finetune/ConstraintLM/constraintlm/processors/guide.py", line 229, in get_next_state
    parser_state = self._get_parser_state_token_applied(state, int(token_id))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ctisseau/llm_lcd_finetune/ConstraintLM/constraintlm/processors/guide.py", line 275, in _get_parser_state_token_applied
    self.parser.parse_from_state(parser_state, is_end=False)
  File "/home/ctisseau/miniconda3/envs/clm_finetune/lib/python3.11/site-packages/outlines/fsm/parsing.py", line 152, in parse_from_state
    return self.parser.parser.parser.parse_from_state(parse_state, is_end=is_end)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ctisseau/miniconda3/envs/clm_finetune/lib/python3.11/site-packages/outlines/fsm/parsing.py", line 536, in parse_from_state
    for token in state.lexer.lex(state):
  File "/home/ctisseau/llm_lcd_finetune/ConstraintLM/constraintlm/processors/guide.py", line 78, in process
    assert stream_paren_level >= 0
           ^^^^^^^^^^^^^^^^^^^^^^^
AssertionError
